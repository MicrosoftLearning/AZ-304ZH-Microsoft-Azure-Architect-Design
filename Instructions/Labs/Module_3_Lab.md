---
lab:
    title: '3: 使用 Azure Migrate 将 Hyper-V VM 迁移到 Azure'
    module: '模块 3：迁移设计'
---

# 实验室：使用 Azure Migrate 将 Hyper-V VM 迁移到 Azure
# 学生实验室手册

## 实验室场景

尽管 Adatum 企业体系结构团队雄心勃勃地将工作负载现代化以迁移到 Azure，但他们意识到，由于时间紧迫，在许多情况下，仍然有必要采用直接迁移法。为了简化此任务，Adatum 企业体系结构团队开始探索 Azure Migrate 的功能。Azure Migrate 是一个集中式中心，用于评估和迁移到 Azure 本地服务器、基础结构、应用程序和数据。

Azure Migrate 提供以下功能：

- 统一的迁移平台：启动、运行和跟踪向 Azure 迁移的单个门户。
- 系列工具：一系列用于评估和迁移的工具。工具包括 Azure Migrate：服务器评估和 Azure Migrate：服务器迁移。Azure Migrate 与其他 Azure 服务以及其他工具和独立软件供应商 (ISV) 产品集成。
- 评估和迁移：在 Azure Migrate 中心，可以评估和迁移：
- 服务器：评估本地服务器，并将其迁移到 Azure 虚拟机。
- 数据库：评估本地数据库，并将其迁移到 Azure SQL 数据库或 SQL 托管实例。
- Web 应用程序：评估本地 Web 应用程序，并使用 Azure 应用服务迁移助手将其迁移到 Azure 应用服务。
- 虚拟桌面：评估本地虚拟桌面基础结构 (VDI)，并将其迁移到 Azure 中的 Windows 虚拟桌面。
- 数据：使用 Azure Data Box 产品快速、经济高效地将大量数据迁移到 Azure。

尽管数据库、Web 应用和虚拟桌面属于迁移计划的下一阶段，但 Adatum 企业体系结构团队希望首先评估使用 Azure Migrate 将其本地 Hyper-V 虚拟机迁移到 Azure VM 时的情况。

## 目标
  
完成本实验室后，你将能够：

-  使用 Azure Migrate 准备好 Hyper-V 以进行评估和迁移

-  使用 Azure Migrate 评估 Hyper-V 以进行迁移

-  使用 Azure Migrate 迁移 Hyper-V VM


## 实验室环境
  
Windows Server 管理员凭据

-  用户名： **Student**

-  密码： **Pa55w.rd1234**

预计用时： 120 分钟


## 实验室文件

-  \\\\AZ304\\AllFiles\\Labs\\08\\azuredeploy30308suba.json


### 练习 0：准备实验室环境

本练习的主要任务如下：

1. 请使用 Azure 资源管理器快速启动模板部署 Azure VM

1. 在 Azure VM 中配置嵌套虚拟化


#### 任务 1：请使用 Azure 资源管理器快速启动模板部署 Azure VM

1. 在实验计算机上，启动 Web 浏览器，导航至 [Azure 门户](https://portal.azure.com) - `portal.azure.com`，然后通过在本实验中使用的订阅中提供具有所有者角色的用户帐户凭据来登录。

1. 在 Azure 门户中，通过直接选择搜索文本框右侧的工具栏图标打开 **“Cloud Shell”** 窗格。

1. 提示选择 **“Bash”** 或 **“PowerShell”** 时，选择 **“PowerShell”**。 

   >**备注**： 如果这是你第一次打开 **Cloud Shell**，会看到 **“未装载任何存储”** 消息，请选择你在本实验室中使用的订阅，然后选择 **“创建存储”**。 

1. 在“Cloud Shell”窗格的工具栏中，选择 **“上传/下载文件”** 图标，在下拉菜单中选择 **“上传”**，然后将文件 **\\\\AZ303\\AllFiles\Labs\\08\\azuredeploy30308suba.json** 上传到 Cloud Shell 主目录中。

1. 在 Cloud Shell 中，运行以下命令在你附近的 Azure 区域设置名为 location 的变量（将“<Azure region>”占位符替换为订阅中可部署 Azure VM 且最接近实验计算机位置的 Azure 区域的名称，例如“eastus”）：

   ```powershell
   $location = '<Azure region>'
   ```

      > **备注**： 若要标识可在其中预配 Azure VM 的 Azure 区域，请参阅[**https://azure.microsoft.com/zh-cn/regions/offers/**](https://azure.microsoft.com/zh-cn/regions/offers/)
      
1. 从 Cloud Shell 窗格运行以下命令，以创建资源组：

   ```powershell
   New-AzSubscriptionDeployment `
     -Location $location `
     -Name az30308subaDeployment `
     -TemplateFile $HOME/azuredeploy30308suba.json `
     -rgLocation $location `
     -rgName 'az30308a-labRG'
   ```

1. 在 Azure 门户中，关闭 **“Cloud Shell”** 窗格。

1. 在实验室计算机上，打开另一个浏览器选项卡，导航到 [“虚拟网络中的 301 嵌套虚拟机 Azure 快速启动模板”](https://github.com/Azure/azure-quickstart-templates/tree/master/301-nested-vms-in-virtual-network)，然后选择 **“部署到 Azure”**。这将自动将浏览器重定向到 Azure 门户中的 **“具有嵌套 VM 的 Hyper-V 主机虚拟机”** 边栏选项卡。

    ``` url
    https://github.com/Azure/azure-quickstart-templates/tree/master/301-nested-vms-in-virtual-network
    ```

1. 在 Azure 门户中 **“具有嵌套 VM 的 Hyper-V 主机虚拟机”** 边栏选项卡上，指定以下设置（将其他设置保留为其默认值）：

    | 设置 | 值 | 
    | --- | --- |
    | 订阅 | 在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | **az30308a-labRG** |
    | 主机公共 IP 地址名 | **az30308a-hv-vm-pip** |
    | 虚拟网络名称 | **az30308a-hv-vnet** |
    | 主机网络界面 1 名 | **az30308a-hv-vm-nic1** |
    | 主机网络界面 2 名 | **az30308a-hv-vm-nic2** |
    | 主机虚拟机名 | **az30308a-hv-vm** |
    | 主机管理员用户名 | **Student** |
    | 主机管理员密码 | **Pa55w.rd1234** |

1. 在 **“具有嵌套 VM 的 Hyper-V 主机虚拟机”** 边栏选项卡上，选择 **“查看 + 创建”**，然后选择 **“创建”**。

    > **备注**： 等待部署完成。该部署可能需要 10 分钟左右。

#### 任务 2：在 Azure VM 中配置嵌套虚拟化

1. 在 Azure 门户中，搜索并选择 **“虚拟机”**，然后在 **“虚拟机”** 边栏选项卡，选择 **“az30308a-hv-vm”**。

1. 在 **“az30308a-hv-vm”** 边栏选项卡中，选择 **“网络”**。 

1. 在 **“az30308a-hv-vm | 网络”** 边栏选项卡，确保已选择 **“az30308a-hv-vm-nic1”**，然后选择 **“添加入站端口规则”**。

    >**备注**： 确保你修改了 **“az30308a-hv-vm-nic1”** 的设置，该设置已为其分配公共 IP 地址。

1. 在 **“添加入站安全规则”** 边栏选项卡中，指定以下设置（将其他设置保留为默认值）并选择 **“添加”** ：

    | 设置 | 值 | 
    | --- | --- |
    | 目标端口范围 | **3389** |
    | 协议 | **任何** |
    | 名称 | **AllowRDPInBound** |

1. 在 **“az30308a-hv-vm”** 边栏选项卡中，选择 **“概述”**。 

1. 在 **“az30308a-hv-vm”** 边栏选项卡中，选择 **“连接”**，在下拉菜单中选择 **“RDP”**，然后单击 **“下载 RDP 文件”**。

1. 系统出现提示时，单击 **“连接”** 并使用以下凭据登录：

    | 设置 | 值 | 
    | --- | --- |
    | 用户名 | **Student** |
    | 密码 | **Pa55w.rd1234** |

1. 在与 **az30308a-hv-vm** 的远程桌面会话中，在“服务器管理器”窗口中，单击 **“本地服务器”**，再单击 **“IE 增强的安全性配置”** 标签旁边的 **“开启”** 链接，然后在 **“IE 增强的安全性配置”** 对话框中选择 **“关闭”** 选项，然后单击 **“确定”**。

1. 在远程桌面会话中，打开文件资源管理器，然后导航至 **“F:”**。创建名为 **VHDs** 的文件夹。

1. 在与 **az30308a-hv-vm** 的远程桌面会话中，启动 Internet Explorer，导航到 [Microsoft Edge](https://www.microsoft.com/zh-cn/edge/business/download) 的下载页面，下载 Microsoft Edge 安装程序并执行安装。 

1. 在与 **az30308a-hv-vm** 的远程桌面会话中，使用 Microsoft Edge 浏览至 [Windows Server 评估](https://www.microsoft.com/zh-cn/evalcenter/evaluate-windows-server-2019)，然后将 Windows Server 2019 **VHD** 文件下载到 **F:\VHDs** 文件夹。 
    
    ```url
    https://www.microsoft.com/zh-cn/evalcenter/evaluate-windows-server-2019
    ```
    
    > **备注**： 评估页面将要求输入个人信息才能完成下载。选择“英国”或其他国家/地区，以退出通知。

1. 在与 **az30308a-hv-vm** 的远程桌面会话中，单击“开始”，再单击 **“Windows 管理工具”**，然后启动 **“Hyper-V 管理器”**。 

1. 在 **“Hyper-V 管理器”** 控制台中，选择 **az30308a-hv-vm** 节点。 

1. 单击 **“新建”**，然后在级联菜单中选择 **“虚拟机”**。这将启动 **“新建虚拟机向导”**。 

1. 在 **“新建虚拟机向导”** 的 **“开始之前”** 页面上，选择 **“下一步 >”**。

1. 在 **“新建虚拟机向导”** 的 **“指定名称和位置”** 页面上，指定以下设置并选择 **“下一步 >”**：

    | 设置 | 值 | 
    | --- | --- |
    | 名称 | **az30308a-vm1** | 
    | 将虚拟机存储在其他位置 | 已选择 | 
    | 位置 | **F:\VMs** |

    >**备注**： 务必创建 **F:\VMs** 文件夹。

1. 在 **“新建虚拟机向导”** 的 **“指定代数”** 页面上，确保选择了 **“第一代”** 选项，然后选择 **“下一步 >”**：

1. 在 **“新建虚拟机向导”** 的 **“分配内存”** 页面上，将 **“启动内存”** 设置为 **“2048”**，然后选择 **“下一步 >”**。

1. 在 **“新建虚拟机向导”** 的 **“配置网络”** 页面上，在 **“连接”** 下拉列表中选择 **“NestedSwitch”**，然后选择 **“下一步 >”**。

1. 在 **“新建虚拟机向导”** 的 **“连接虚拟硬盘”** 页面上，选择 **“使用现有的虚拟硬盘”** 选项，将 VHD 文件下载到的位置设置为 **F:\VHDs** 文件夹，然后选择 **“下一步 >”**。

1. 在 **“新建虚拟机向导”** 的 **“摘要”** 页面上，选择 **“完成”**。

1. 在 **“Hyper-V 管理器”** 控制台中，选择新创建的虚拟机，然后选择 **“启动”**。 

1. 在 **“Hyper-V 管理器”** 控制台中，确认虚拟机正在运行，然后选择 **“连接”**。 

1. 在 **az30308a-vm1** 的“虚拟机连接”窗口中的 **“你好”** 页面上，选择 **“下一步”**。 

1. 在 **az30308a-vm1** 的“虚拟机连接”窗口的 **“许可条款”** 页面上，选择 **“接受”**。 

1. 在到 **“az30308a-vm1”** 的虚拟机连接窗口，在 **“自定义设置”** 页面上，将内置管理员帐户的密码设置为 **“Pa55w.rd1234”**，然后选择 **“完成”**。 

1. 在到 **“az30308a-vm1”** 的虚拟机连接窗口，使用新设置的密码登录。

1. 在到 **“az30308a-vm1”** 的虚拟机连接窗口中，启动 Windows PowerShell，然后在 **“管理员： Windows PowerShell”** 窗口运行以下命令来设置计算机名。 

   ```powershell
   Rename-Computer -NewName 'az30308a-vm1' -Restart
   ```

### 练习 1：使用 Azure Migrate 准备评估和迁移
  
本练习的主要任务如下：

1. 配置 Hyper-V 环境

1. 创建 Azure Migrate 项目

1. 实现目标 Azure 环境


#### 任务 1：配置 Hyper-V 环境

1. 在与 **az30308a-hv-vm** 的远程桌面会话中，启动 Microsoft Edge，导航至 [Microsoft 下载中心](https://aka.ms/migrate/script/hyperv)，然后将配置 PowerShell 脚本下载到 **F:** 盘。

    ```url
    https://aka.ms/migrate/script/hyperv
    ```

    >**备注**： 脚本将执行以下任务：

    - 检查你是否在受支持的 PowerShell 版本上运行脚本。

    - 验证你在 Hyper-V 主机上是否具有管理权限。

    - 允许你创建 Azure Migrate 服务用来与 Hyper-V 主机进行通信的本地用户帐户。该用户帐户将被添加到 Hyper-V 主机上的“远程管理用户”、“Hyper-V 管理员”和“性能监视器用户”组。

    - 检查主机是否正在运行受支持的 Hyper-V 版本以及 Hyper-V 角色。

    - 启用 WinRM 服务，并在主机上打开端口 5985 (HTTP) 和 5986 (HTTPS)。这是元数据收集所必需的。

    - 在主机上启用 PowerShell 远程处理。

    - 检查在主机托管的所有 VM 上是否启用了 Hyper-V 集成服务。

    - 如果需要，在主机上启用 CredSSP。

1. 在与 **az30308a-hv-vm** 的远程桌面会话中，启动 **“Windows PowerShell ISE”**。 

1. 在 **“管理员: Windows PowerShell ISE”** 窗口，在“控制台”窗格中，运行以下命令以删除 Zone.Identifier 备用数据流，在这种情况下，该备用数据流表示文件是从 Internet 下载的。

   ```powershell
   Unblock-File -Path F:\MicrosoftAzureMigrate-Hyper-V.ps1
   ```

1. 在 **“管理员: Windows PowerShell ISE”** 窗口中，打开位于 **F:** 文件夹中的 **“MicrosoftAzureMigrate-Hyper-V.ps1”** 脚本并并运行该脚本。系统提示进行确认时，请按 **Y** 键，然后按 **Enter** 键，但以下提示除外，在这种情况下，键入 **N**，然后按 **Enter** 键：

- 是否使用 SMB 共享来存储 VHD？

- 是否要为 Azure Migrate 和 Hyper-V 主机通信创建非管理员本地用户？ 


#### 任务 2：创建 Azure Migrate 项目

1. 在与 **az30308a-hv-vm** 的远程桌面会话中，启动 Microsoft Edge，导航至 [Azure 门户](https://portal.azure.com)，然后通过提供你将在本实验室使用的订阅中具有所有者角色的用户帐户凭据来登录。

1. 在 Azure 门户中，搜索并选择 **“Azure Migrate”**，在 **“Azure Migrate”** 边栏选项卡的 **“迁移目标”** 部分选择 **“服务器”**，然后选择 **“创建项目”**。

1. 在 **“Azure Migrate”** 边栏选项卡中，指定以下设置（将其他设置保留为默认值），然后选择 **“创建”**：

    | 设置 | 值 | 
    | --- | --- |
    | 订阅 | 在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | 新资源组名称 **az30308b-labRG** |
    | 迁移项目 | **az30308b-migrate-project** |
    | 地理 | 所在国家/地区或地理区域的名称 |


#### 任务 3：实现目标 Azure 环境

1. 在 Azure 门户中，搜索并选择 **“虚拟网络”**，然后在 **“虚拟网络”** 边栏选项卡上，选择 **“+ 新建”**。

1. 在 **“创建虚拟网络”** 边栏选项卡的 **“基本设置”** 选项卡上，指定以下设置（将其他设置保留为默认值）并选择 **“下一步: IP 地址**：

    | 设置 | 值 |
    | --- | --- |
    | 订阅 | 在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | 新资源组名称 **az30308c-labRG** |
    | 名称 | **az30308c-migration-vnet** |
    | 区域 | 本实验前面将虚拟机部署到其中的 Azure 区域的名称 |

1. 在 **“创建虚拟网络”** 边栏选项卡的 **“IP 地址”** 选项卡上的 **“IPv4 地址空间”** 文本框中，键入 **“10.8.0.0/16”**，然后选择 **“+ 添加子网”**。

1. 在 **“添加子网”** 边栏选项卡上，指定以下设置（将其他设置保留为默认值）并选择 **“添加”**：

    | 设置 | 值 |
    | --- | --- |
    | 子网名 | **subnet0** |
    | 子网地址范围 | **10.8.0.0/24** |

1. 返回到 **“创建虚拟网络”** 边栏选项卡的 **“IP 地址”** 选项卡，选择 **“查看 + 创建”**。

1. 在 **“创建虚拟网络”** 边栏选项卡的 **“查看 + 创建”** 选项卡上，选择 **“创建”**。

1. 在 Azure 门户中，搜索并选择 **“虚拟网络”**，然后在 **“虚拟网络”** 边栏选项卡上，选择 **“+ 新建”**。

1. 在 **“创建虚拟网络”** 边栏选项卡的 **“基本设置”** 选项卡上，指定以下设置（将其他设置保留为默认值）并选择 **“下一步: IP 地址**：

    | 设置 | 值 |
    | --- | --- |
    | 订阅 | 在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | **az30308c-labRG** |
    | 名称 | **az30308c-test-vnet** |
    | 区域 | 本实验前面将虚拟机部署到其中的 Azure 区域的名称 |

1. 在 **“创建虚拟网络”** 边栏选项卡的 **“IP 地址”** 选项卡上的 **“IPv4 地址空间”** 文本框中，键入 **“10.8.0.0/16”**，然后选择 **“+ 添加子网”**。

1. 在 **“添加子网”** 边栏选项卡上，指定以下设置（将其他设置保留为默认值）并选择 **“添加”**：

    | 设置 | 值 |
    | --- | --- |
    | 子网名 | **subnet0** |
    | 子网地址范围 | **10.8.0.0/24** |

1. 返回到 **“创建虚拟网络”** 边栏选项卡的 **“IP 地址”** 选项卡，选择 **“查看 + 创建”**。

1. 在 **“创建虚拟网络”** 边栏选项卡的 **“查看 + 创建”** 选项卡上，选择 **“创建”**。

1. 在 Azure 门户中，搜索并选择 **“存储帐户”**，然后在 **“存储帐户”** 边栏选项卡上，选择 **“+ 新建”**。

1. 在 **“创建存储帐户”** 边栏选项卡的 **“基本设置”** 选项卡上，指定以下设置（其他设置则保留为默认值）：

    | 设置 | 值 | 
    | --- | --- |
    | 订阅 | 在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | **az30308c-labRG** |
    | 存储帐户名称 | 由字母和数字组成、介于 3-24 个字符的任何全局唯一名称 |
    | 位置 | 本任务初期在其中创建虚拟网络的 Azure 区域的名称 |
    | 性能 | **标准** |
    | 帐户类型 | **StorageV2（常规用途 v2）** |
    | 复制 | **本地冗余存储 (LRS)** |

1. 在 **“创建存储帐户”** 边栏选项卡的 **“基本设置”** 选项卡中，选择 **“查看 + 创建”**。

1. 在 **“创建存储帐户”** 边栏选项卡的 **“查看 + 创建”** 选项卡中，选择 **“创建”**。


### 练习 2：使用 Azure Migrate 评估 Hyper-V 以进行迁移
  
本练习的主要任务如下：

1. 部署和配置 Azure Migrate 设备

1. 配置、运行和查看评估


#### 任务 1：部署和配置 Azure Migrate 设备

1. 在与 **az30308a-hv-vm** 的远程桌面会话中，在 Microsoft Edge 窗口的 Azure 门户中搜索并选择 **“Azure Migrate”**。

1. 在 **“Azure Migrate | 服务器”** 边栏选项卡中，选择 **“Azure Migrate: 服务器评估”** 磁贴。 

1. 在 **“发现计算机”** 边栏选项卡上的 **“你的计算机是否已虚拟化”** 下拉列表中，选择 **“是，使用 Hyper-V”**。 

1. 在 **“发现计算机”** 边栏选项卡上的 **“为设备命名”** 文本框中，键入 **“az30308a-vma1”**，然后选择 **“生成密钥”** 按钮。

   >**备注**： 如果在生成 Azure Migrate 项目密钥时遇到与权限相关的错误，请在 Azure 门户中导航到 **“订阅”** 边栏选项卡，选择你的订阅，在订阅边栏选项卡上，选择 **“访问控制(IAM)”**，然后将 **“所有者”** 角色分配到你的 Azure AD 用户帐户。

1. 等待资源预配完成，在与 **az30308a-hv-vm** 的远程桌面会话中，启动记事本，然后将 **“Azure Migrate 项目密钥”** 复制到记事本中。 

1. 在 **“发现计算机”** 边栏选项卡上的 **“下载 Azure Migrate 设备”** 文本框中，选择 **“VHD 文件”** 选项，然后选择 **“下载”**。当系统出现提示时，将下载位置设置为 **F:\VMs** 文件夹。

   >**备注**： 等待下载完成。该操作需要约 5 分钟。

1. 下载完成后，将下载的 .ZIP 文件的内容提取到 **F:\VMs** 文件夹。 

1. 在接入 **az30308a-hv-vm** 的远程桌面会话中，切换到 **“Hyper-V 管理器”** 控制台，选择 **“az30308a-hv-vm”** 节点，选择 **“导入虚拟机”**。这将开始执行**导入虚拟机**向导。

1. 在**导入虚拟机**向导的 **“开始之前”** 页面，选择 **“下一步 >”**。

1. 在 **“导入虚拟机”** 向导的 **“查找文件夹”** 页面中，指定提取的 **“虚拟机”** 文件夹的位置，然后选择 **“下一步 >”**：

1. 在 **“导入虚拟机”** 向导的 **“选择虚拟机”** 页面上，选择 **“下一步 >”**：

1. 在 **“导入虚拟机”** 向导的 **“选择导入类型”** 页面上，选择 **“就地注册虚拟机(使用现有的唯一 ID)”**，然后选择 **“下一步 >”**。

1. 在 **“导入虚拟机”** 向导的 **“配置处理器”** 页面中，将 **“虚拟处理器数量”** 设置为 **“4”**，然后选择 **“下一步 >”**。

   >**备注**： 请忽略任何涉及虚拟处理器数量变化的错误消息。

1. 在 **“导入虚拟机”** 向导的 **“连接网络”** 页面中，在 **“连接”** 下拉列表中选择 **“NestedSwitch”**，然后选择 **“下一步 >”**。

1. **在导入虚拟机**向导的 **“摘要”** 页面中，选择 **“完成”**。

   >**备注**： 等待导入完成。该操作需要约 10 分钟。

1. 在 **Hyper-V 管理器** 控制台，选择新导入的虚拟机，然后选择 **“重命名”**，并将名称设置为 **“az30308a-vma1”**。

1. 在 **Hyper-V 管理器** 控制台，选择新导入的虚拟机，然后选择 **“启动”**。 

1. 在 **“Hyper-V 管理器”** 控制台中，确认虚拟机正在运行，然后选择 **“连接”**。 

1. 在虚拟设备的“虚拟机连接”窗口中的 **“许可条款”** 页面上，选择 **“接受”**。 

1. 在虚拟设备的“虚拟机连接”窗口中，在 **“自定义设置”** 页面上，将内置“管理员帐户密码”设置为 **“Pa55w.rd1234”**，然后选择 **“完成”**。 

1. 在虚拟设备的“虚拟机连接”窗口中，使用新设置的密码登录。

1. 在虚拟设备的“虚拟机连接”窗口中，启动 Windows PowerShell 并运行以下命令以标识其 IP 地址。

   ```powershell
   (Get-NetIPAddress).IPAddress
   ```

1. 在与 **az30308a-hv-vm** 的远程桌面会话中，下载 Microsoft Edge 并使用默认设置运行安装。

1. 在 Microsoft Edge 窗格中的与 **az30308a-hv-vm** 的远程桌面会话中，导航到 [https://`IPaddress`:44368](https://`IPaddress`:44368)，其中 `IPaddress` 占位符代表你在上一步中标识的 IP 地址。

   >**备注**： 忽略有关网站安全证书的警告。 

1. 出现提示时，请使用以下凭据登录：

    | 设置 | 值 | 
    | --- | --- |
    | 用户名 | **管理员** |
    | 密码 | **Pa55w.rd1234** |

1. 在 Microsoft Edge 窗口中的 **“设备配置管理器”** 页面上，选择 **“我同意”** 按钮，等待先决条件得到成功验证，然后选择 **“继续”**。 

1. 在 Microsoft Edge 窗口中，在 **“设备配置管理器”** 页面上的 **“注册到 Azure Migrate”** 部分的 **“提供 Azure Migrate 项目密钥”** 文本框中，粘贴你在本练习的前面部分复制到记事本中的密钥，选择 **“登录”**，接受显示的默认代码并将其复制到剪贴板中，然后选择 **“复制代码并登录”**，在浏览器页面的 **“输入代码”** 窗格中粘贴复制到剪贴板中的代码，并选择 **“下一步”**，通过提供在本实验中所用订阅中具有所有者角色的用户帐户凭据来登录，然后关闭浏览器页面。 

1. 在 Microsoft Edge 窗口中的 **“设备配置管理器”** 页面上，验证注册是否成功，然后选择 **“继续”**。 

1. 在 Microsoft Edge 窗口中，在 **“设备配置管理器”** 页面上的 **“管理凭据和发现源”** 部分，选择 **“添加凭据”**，在 **“添加凭据”** 窗格中指定以下设置，然后选择 **“保存”**：

    | 设置 | 值 | 
    | --- | --- |
    | 友好名称 | **az30308acreds** |    
    | 用户名 | **Student** |
    | 密码 | **Pa55w.rd1234** |

1. 在 Microsoft Edge 窗口中，在 **“设备配置管理器”** 页面的 **“提供 Hyper-V 主机/群集详细信息”** 部分，选择 **“添加发现源”**，在 **“添加发现源”** 窗格中，选择 **“添加单个项目”** 选项，请确保 **“发现源”** 下拉列表设置为 **“Hyper-V 主机/群集”**，在 **“友好名称”** 下拉列表中，选择 **“az30308acreds”** 条目，在 **“IP 地址/FQDN”** 文本框中，键入 **10.0.2.1**，然后选择 **“保存”**。 

1. 在 Microsoft Edge 窗口中，在 **“设备配置管理器”** 页面的 **“提供 Hyper-V 主机/群集详细信息”** 部分，选择 **“开始发现”**。 

   >**备注**： 一般来说，每台主机大约需要 15 分钟才能将发现的服务器的元数据显示在 Azure 门户中。


#### 任务 2：配置、运行和查看评估

1. 在与 **az30308a-hv-vm** 的远程桌面会话中，在显示 Azure 门户的 Microsoft Edge 窗口中，导航回 **“Azure Migrate | 服务器”** 边栏选项卡，选择 **“刷新”**，然后在 **“Azure Migrate： 服务器评估”** 磁贴中选择 **“评估”**。

   >**备注**： 可能需要再次刷新页面。 

1. 在 **“评估属性”** 边栏选项卡中选择 **“编辑”**，指定以下设置（将其他设置保留为默认值）并选择 **“保存”**：

    | 设置 | 值 | 
    | --- | --- |
    | 目标位置 | 在本实验中使用的 Azure 区域的名称 |
    | 存储类型 | **自动** |
    | 预留实例 | **无预留实例** |
    | 大小调整标准 | **作为本地** |
    | VM 系列 | **Dsv3 系列** |
    | 舒适因子 | **1** |
    | 优惠 | **即用即付** |
    | 货币 | 美元 ($) | 
    | 折扣 | **0** |
    | VM 正常运行时间 | 每月 **31** 天，每天 **24** 小时| 

   >**备注**： 考虑到实验环境固有的时间有限，这种情况下唯一可行的选择是 **“本地”** 评估。 

1. 返回到 **“评估服务器”** 边栏选项卡，选择 **“下一步”**，然后导航到 **“选择要评估的计算机”** 选项卡。

1. 将 **“评估名称”** 设置为 **“az30308a-assessment”**。

1. 确保已选中 **“新建”** 选项，将组名设置为 **az30308a-assessment-group**，在要添加到该组的计算机列表中，选择 **“az30308a-vm1”**。

1. 单击 **“下一步”**，再单击 **“创建评估”**。 

1. 导航回 **“Azure Migrate | 服务器”** 边栏选项卡，选择 **“刷新”**，在 **“Azure Migrate: 服务器评估”** 磁贴中，验证 **“评估”** 行是否包含 **1** 个条目，然后选择该条目。

1. 在 **“Azure Migrate: 服务器评估 | 评估”** 边栏选项卡上，选择新建的评估 **az30308a-assessment**。 

1. 在 **“az30308a-assessment”** 边栏选项卡上，查看指示 Azure 迁移就绪性以及每月计算和存储估算成本的信息。 

   >**备注**： 在真实场景中，你应该考虑安装依赖项代理，以便在评估阶段提供有关服务器依赖项的更多见解。


### 练习 3：使用 Azure Migrate 迁移 Hyper-V VM
  
本练习的主要任务如下：

1. 准备迁移 Hyper-V VM

1. 配置 Hyper-V VM 的复制

1. 执行 Hyper-V VM 迁移

1. 删除实验室中部署的 Azure 资源


#### 任务 1：准备迁移 Hyper-V VM

1. 在与 **az30308a-hv-vm** 的远程桌面会话中，在显示 Azure 门户的 Microsoft Edge 窗口中，导航回 **“Azure Migrate | 服务器”** 边栏选项卡的浏览器页面。 

1. 在 **“Azure Migrate | 服务器”** 边栏选项卡，在 **“Azure Migrate: 服务器迁移”** 磁贴中，选择 **“发现”** 链接。 

1. 在 **“发现计算机”** 边栏选项卡上，指定以下设置（将其他设置保留为默认值），然后选择 **“创建资源”**：

    | 设置 | 值 | 
    | --- | --- |
    | 你的计算机是否虚拟化？ | **是的，使用 Hyper-V** |
    | 目标区域 | 在本实验中使用的 Azure 区域的名称 | 
    | 确认要迁移到的目标区域 | 已选择 |

    >**备注**： 此步骤将自动触发 Azure Site Recovery 保管库的预配。

1. 在 **“发现计算机”** 边栏选项卡上，在 **“准备 Hyper-V 主机服务器” 1.**  步骤中，选择第一个 **“下载”** 链接（不是“下载”按钮），以下载 Hyper-V 复制提供程序软件的安装程序。

1. 系统出现提示时，启动 **AzureSiteRecoveryProvider.exe**。这将启动 **Azure Site Recovery 提供程序安装程序（Hyper-V 服务器）** 向导。

1. 在 **“Microsoft 更新”** 页面上，选择 **“关闭”**，然后选择 **“下一步”**。

1. 在 **“提供程序安装”** 页面上，选择 **“安装”**。

1. 切换到 Azure 门户，在 **“发现计算机”** 边栏选项卡上，选择本地 Hyper-V 主机准备程序步骤 1 中的 **“下载”** 按钮，以下载保管库注册密钥。系统出现提示时，将注册密钥保存在 **“下载”** 文件夹中。

1. 切换到 **“提供程序安装”** 页面并选择 **“注册”**。这将启动 **Microsoft Azure Site Recovery 注册向导**。

1. 在 **Microsoft Azure Site Recovery 注册向导** 的 **“保管库设置”** 页面上，选择 **“浏览”**，导航到 **“下载”** 文件夹，选择保管库凭据文件，然后选择 **“打开”**。

1. 返回到 **Microsoft Azure Site Recovery 注册向导** 的 **“保管库设置”** 页面，选择 **“下一步”**。

1. 在 **Microsoft Azure Site Recovery 注册向导** 的 **“代理设置”** 页面 上，接受默认设置，然后选择 **“下一步”**。

1. 在 **Microsoft Azure Site Recovery 注册向导** 的 **“注册”** 页面上，选择 **“完成”**。

1. 注册过程完成后，在 **“发现计算机”** 边栏选项卡上，选择 **“完成注册”**。

   >**备注**： 可能需要刷新显示 **“发现计算机”** 边栏选项卡的浏览器页面，然后导航回该页面。

   >**备注**： 发现虚拟机的过程最多可能需要 15 分钟才能完成。


#### 任务 2：配置 Hyper-V VM 的复制

1. 收到注册已完成的确认信息后，导航回 **“Azure Migrate | 服务器”** 边栏选项卡，在 **“Azure Migrate: 服务器迁移”** 磁贴上，选择 **“复制”** 链接。 

   >**备注**： 可能需要刷新显示 **“Azure Migrate | 服务器”** 边栏选项卡的浏览器页面。

1. 在 **“复制”** 边栏选项卡的 **“源设置”** 页面，在 **“你的计算机是否已虚拟化？”** 下拉列表中，选择 **“是，使用 Hyper-V”**，然后选择 **“下一步： 虚拟机”**。  

1. 在 **“复制”** 边栏选项卡的 **“虚拟机”** 页面中指定以下设置（将其他设置保留为默认值），然后选择 **“下一步: 下一部分： 目标设置”**：

    | 设置 | 值 | 
    | --- | --- |
    | 从 Azure Migrate 评估导入迁移设置 | **是，根据 Azure Migrate 评估应用迁移设置** |
    | 选择组 | **az30308a-assessment-group** |
    | 选择评估 | **az30308a-assessment** |
    | 虚拟机 | **az30308a-vm1** |

1. 在 **“复制”** 边栏选项卡的 **“目标设置”** 页面中指定以下设置（将其他设置保留为默认值），并选择 **“下一步： 计算”**：

    | 设置 | 值 | 
    | --- | --- |
    | 订阅 | 在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | **az30308c-labRG** |
    | 复制存储帐户 | 之前在本实验室中创建的存储帐户的名称 | 
    | 虚拟网络 | **az30308c-migration-vnet** |
    | 子网 | **subnet0** |

1. 在 **“复制”** 边栏选项卡的 **“计算”** 页面上，确保选中 **“Azure VM 大小”** 下拉列表中的 **“Standard_D2s_v3”**，在 **“OS 类型”** 下拉列表中，选择 **“Windows”**，然后选择 **“下一步: 磁盘”**。  

1. 在 **“复制”** 边栏选项卡的 **“磁盘”** 页面上，接受默认设置，然后选择 **“下一步: 查看 + 开始复制”**。  

1. 在 **“复制”** 边栏选项卡的 **“查看 + 开始复制”** 页面上，选择 **“复制”**。  

1. 若要监视复制状态，请导航回 **“Azure Migrate | 服务器”** 边栏选项卡，在 **“Azure Migrate: 服务器迁移”** 磁贴，选择 **“复制服务器”** 条目，在 **“Azure Migrate: 服务器迁移 | 复制计算机”** 上，检查复制计算机列表中的 **“状态”** 列。

1. 等到状态变更为 **“受保护”**。该操作可能还需要 15 分钟。


#### 任务 3：执行 Hyper-V VM 迁移

1. 在 Azure 门户中的 **“Azure Migrate: 服务器迁移 | 复制计算机”** 上，选择代表 **“az30308a-vm1”** 虚拟机的条目。

1. 在 **az30308a-vm1** 复制计算机边栏选项卡上，选择 **“测试迁移”**。

1. 在 **“测试迁移”** 边栏选项卡的 **“虚拟网络”** 下拉列表中，选择 **“az30308c-test-vnet”**，然后选择 **“测试迁移”**。

   >**备注**： 等待测试迁移完成。该操作需要约 5 分钟。

1. 在 Azure 门户中，搜索并选择 **“虚拟机”**，在 **“虚拟机”** 边栏选项卡上，注意代表新预配的虚拟机 **“az30308a-vm1-test”** 的条目。

1. 在 Azure 门户中，导航回 **“Azure Migrate: 服务器迁移 | 复制计算机”**，选择 **“刷新”**，然后验证 **az30308a-vm1** 虚拟机是否列出并具有 **“清理测试故障转移挂起”** 状态。

1. 在 **“Azure Migrate: 服务器迁移 | 复制计算机”** 边栏选项卡上，选择代表 **az30308a-vm1** 虚拟机的条目。

1. 在 **“az30308a-vm1 复制计算机”** 边栏选项卡上，选择 **“清理测试迁移”**。

1. 在 **“测试迁移清理”** 边栏选项卡上，选择复选框 **“测试完成**。 删除测试虚拟机”**，然后选择 **“清理测试”**。

1. 测试故障转移清理作业完成后，刷新显示 **“az30308a-vm1 复制计算机”** 边栏选项卡的浏览器页面，并注意工具栏中的 **“迁移”** 图标将自动变为可用。

1. 在 **“az30308a-vm1”** 复制计算机边栏选项卡上，选择 **“迁移”** 链接。 

1. 在 **“迁移”** 边栏选项卡上的 **“在迁移之前关闭计算机以最大程度地减少数据丢失?”** 下拉列表中，选择 **“是”**，然后选中 **“az30308a-vm1”** 条目旁边的复选框，然后选择 **“迁移”**。

1. 若要监视迁移状态，请导航回 **“Azure Migrate” | 服务器”** 边栏选项卡，在 **“Azure Migrate: 服务器迁移”** 磁贴，选择 **“复制服务器”** 条目，在 **“Azure Migrate: 服务器迁移 | 复制计算机”** 上，检查复制计算机列表中的 **“状态”** 列。验证状态是否显示为 **“计划内故障转移完成”** 状态。

   >**备注**： 迁移应该是不可逆的操作。如果想要查看完整信息，请导航回“Azure Migrate | 服务器”边栏选项卡，刷新页面并验证“Azure Migrate: 服务器迁移”磁贴中“已迁移服务器数”的值为 1。


#### 任务 4：删除实验室中部署的 Azure 资源

1. 在 **“az30308a-vm0”** 的远程桌面会话中，在显示 Azure 门户的浏览器窗口中，在“Cloud Shell”窗格中启动 PowerShell 会话。

1. 在“Cloud Shell”窗格中运行以下命令，以列出你在本练习中创建的资源组：

   ```powershell
   Get-AzResourceGroup -Name 'az30308*'
   ```

   > **备注**： 验证输出结果是否仅包含你在本实验室中创建的资源组。在本任务中将删除这个组。

1. 在“Cloud Shell”窗格中运行以下命令，以删除在本实验室中创建的资源组

   ```powershell
   Get-AzResourceGroup -Name 'az30308*' | Remove-AzResourceGroup -Force -AsJob
   ```

1. 关闭 Cloud Shell 窗格。
