---
lab:
    title: '13: 实现 Azure 逻辑应用与 Azure 事件网格的集成'
    module: '模块 13：设计应用程序架构'
---

# 实验室：实现 Azure 逻辑应用与 Azure 事件网格的集成
# 学生实验室手册

## 实验室场景
Adatum Corporation 拥有一套广泛的内部网络监视框架，这些框架依赖于基于代理和无代理解决方案的组合，以提供对其环境的任何更改的可见性。由于无代理解决方案依靠轮询来确定状态变化，因此它们往往效率相对较低。 

在 Adatum 准备将其部分工作负载迁移到 Azure 时，其企业体系结构团队希望解决这些低效率问题，并评估是否应采用云提供的事件驱动体系结构。在解决方案或应用程序中使用事件的概念对于该团队而言并不陌生。实际上，他们一直在其开发人员中推广事件驱动编程的想法。事件驱动的体系结构的核心原则之一是消除现有服务之间可能存在的依赖关系。Azure 通过依赖事件网格来提供此功能，事件网格是一种完全托管的服务，通过使用发布者-订阅者模型来支持事件的路由。事件网格的核心是事件路由服务，它管理来自众多来源和订户的事件的路由和传递。

由发布者（例如 Blob 存储帐户、Azure 资源组或甚至 Azure 订阅）创建事件。事件发生时，它们将发布到主题终结点，事件网格服务可管理该终结点来消化所有传入消息。事件发布者不仅限于 Azure 上的服务。可以使用源自可在任何地方运行的自定义应用程序或系统的事件。如果可以将 HTTP 请求发布到事件网格服务，这就会包括在本地、数据中心或甚至其他云中托管的应用程序。

事件处理程序包括几种 Azure 服务，其中包含无服务器技术，例如 Functions、逻辑应用或 Azure 自动化。通过创建事件订阅，向事件网格注册处理程序。如果事件处理程序终结点可以由传输层安全性公开访问并进行加密，则可以从事件网格将消息推送到该事件处理程序终结点。

与许多其他 Azure 服务不同，不存在需要预配或管理的事件网格名称空间。内置了本机 Azure 资源的主题，这些主题对用户完全透明，而自定义主题是临时预配的，并且存在于资源组中。事件订阅仅与主题相关联。此模型简化了订阅主题的管理，并使事件网格更好地管理多租户，从而可以进行大规模横向扩展。

Azure 事件网格与任何语言或平台都无关。尽管它与 Azure 服务本地集成，但支持 HTTP 协议的任何应用都可以轻松利用它，这使其成为非常智能和创新的服务。

为了探索此功能，Adatum 体系结构团队希望测试 Azure 逻辑应用与事件网格的集成，以便：

-  检测何时更改了指定 Azure VM 的状态

-  自动生成响应事件的电子邮件通知


## 目标
  
完成本实验室后，你将能够：

-  将 Azure 逻辑应用与事件网格集成

-  触发逻辑应用的执行，以响应表示对资源组中资源进行更改的事件


## 实验室环境
  
Windows Server 管理员凭据

-  用户名：**Student**

-  密码：**Pa55w.rd1234**

预计用时：60 分钟


## 实验室文件

-  \\\\AZ304\\AllFiles\\Labs\\04\\azuredeploy30304suba.json

-  \\\\AZ304\\AllFiles\\Labs\\04\\azuredeploy30304rga.json

-  \\\\AZ304\\AllFiles\\Labs\\04\\azuredeploy30304rga.parameters.json

## 说明

### 练习 0：准备实验室环境

本练习的主要任务如下：

 1. 使用 Azure 资源管理器模板部署 Azure VM


#### 任务 1：使用 Azure 资源管理器模板部署 Azure VM

1. 在实验室计算机上，启动 Web 浏览器，导航至 [“Azure 门户”](https://portal.azure.com)，然后通过提供要在本实验中使用的订阅中的所有者角色的用户帐户凭据来登录。

1. 在 Azure 门户中，通过直接选择搜索文本框右侧的工具栏图标打开 **“Cloud Shell”** 窗格。

1. 提示选择 **“Bash”** 或 **“PowerShell”** 时，选择 **“PowerShell”**。 

    >**备注**： 如果这是你第一次打开 **Cloud Shell**，会看到 **“未装载任何存储”** 消息，请选择你在本实验室中使用的订阅，然后选择 **“创建存储”**。 

1. 在“Cloud Shell”窗格中运行以下命令，以在订阅中注册 **Microsoft.EventGrid** 提供程序：

   ```powershell
   Register-AzResourceProvider -ProviderNamespace 'Microsoft.EventGrid'
   ```

1. 在“Cloud Shell”窗格的工具栏中，选择 **“上传/下载文件”** 图标，在下拉菜单中选择 **“上传”**，然后将文件 **\\\\AZ304\\AllFiles\Labs\\04\\azuredeploy30304suba.json** 上传到 Cloud Shell 主目录中。

1. 在 Cloud Shell 窗格中，通过运行以下命令创建资源组（用订阅中可用于部署 Azure VM 且最接近实验室计算机位置的 Azure 区域的名称替换 `<Azure region>` 占位符）：

   ```powershell
   $location = '<Azure region>'
   New-AzSubscriptionDeployment `
     -Location $location `
     -Name az30304subaDeployment `
     -TemplateFile $HOME/azuredeploy30304suba.json `
     -rgLocation $location `
     -rgName 'az30304a-labRG'
   ```

      > **备注**： 若要标识可在其中预配 Azure VM 的 Azure 区域，请参阅[**https://azure.microsoft.com/zh-cn/regions/offers/**](https://azure.microsoft.com/zh-cn/regions/offers/)

1. 在 Cloud Shell 窗格中，上传 Azure 资源管理器模板 **\\\\AZ304\\AllFiles\Labs\\04\\azuredeploy30304rga.json**。

1. 在“Cloud Shell”窗格中，上传 Azure 资源管理器参数文件 **\\\\AZ304\\AllFilesLabs\\04\\azuredeploy30304rga.parameters.json**。

1. 在“Cloud Shell”窗格中运行以下命令，以部署将在本实验室中使用的运行 Windows Server 2019 的 Azure VM：

   ```powershell
   New-AzResourceGroupDeployment `
     -Name az30304rgaDeployment `
     -ResourceGroupName 'az30304a-labRG' `
     -TemplateFile $HOME/azuredeploy30304rga.json `
     -TemplateParameterFile $HOME/azuredeploy30304rga.parameters.json `
     -AsJob
   ```

    > **备注**： 不要等待部署完成，而是继续执行下一个练习。部署时间应少于 5 分钟。

1. 在 Azure 门户中，关闭 **“Cloud Shell”** 窗格。 


### 练习 1：为 Azure 逻辑应用配置身份验证和授权

1. 创建 Azure Active Directory 服务主体

1. 将读者角色分配给 Azure AD 服务主体 


#### 任务 1：创建 Azure Active Directory 服务主体

1. 在 Azure 门户中，启动 **Cloud Shell** 中的 **“PowerShell”** 会话。 

1. 在“Cloud Shell”窗格中，运行以下命令以创建新的 Azure AD 应用程序，该应用程序将与你在此任务的后续步骤中创建的服务主体相关联：

   ```powershell
   $password = 'Pa55w.rd1234.@z304'
   $securePassword = ConvertTo-SecureString -Force -AsPlainText -String $password
   $az30304aadapp = New-AzADApplication -DisplayName 'az30304aadsp' -HomePage 'http://az30304aadsp' -IdentifierUris 'http://az30304aadsp' -Password $securePassword
   ```

1. 在“Cloud Shell”窗格中，运行以下命令以创建与你在上一步中创建的应用程序关联的新 Azure AD 服务主体：

   ```powershell
   New-AzADServicePrincipal -ApplicationId $az30304aadapp.ApplicationId.Guid -SkipAssignment
   ```

1. 在 **New-AzADServicePrincipal** 命令的输出中，注意 **ApplicationId** 属性的值。在本次练习中，你后续将需要该域名。

1. 在“Cloud Shell”窗格中，运行以下命令以标识当前 Azure 订阅的 **Id** 属性值和与该订阅关联的 Azure AD 租户的 **TenantId** 属性值（在本练习后面你也需要这些值）：

   ```powershell
   Get-AzSubscription
   ```

1. 关闭 Cloud Shell 窗格。


#### 任务 2：授权对 Azure AD 服务主体的访问 

1. 在 Azure 门户中，搜索并选择 **“资源组”**，然后在 **“资源组”** 边栏选项卡中，选择 **“az30304a-labRG”**。

1. 在 **“az30304a-LabRG”** 边栏选项卡中，选择 **“访问控制(IAM)”**。

1. 在 **“az30304a-labRG | 访问控制(IAM)”** 边栏选项卡上，选择 **“+ 添加”**，然后选择 **“添加角色分配”**。 

1. 在 **“添加角色分配”** 边栏选项卡上，指定以下设置并选择 **“保存”**：

    | 设置 | 值 | 
    | --- | --- |
    | 角色 | **读取者** |
    | 将访问权限分配到 | **用户、组或服务主体** |
    | 选择 | **az30304aadsp** |


### 练习 2：实现 Azure 逻辑应用
  
本练习的主要任务如下：

1. 创建 Azure 逻辑应用

1. 在 Azure 逻辑应用程序中添加触发器

1. 将条件添加到 Azure 逻辑应用

1. 向 Azure 逻辑应用程序添加操作


#### 任务 1：创建 Azure 逻辑应用

1. 在 Azure 门户中，搜索并选择 **“逻辑应用”**，并且在 **“逻辑应用”** 边栏选项卡上，选择 **“+ 添加”**，然后选择 **“使用”**。

1. 在 **“逻辑应用”** 边栏选项卡的 **“基本信息”** 选项卡中，指定以下设置（将其他设置保留为默认值）：

    | 设置 | 值 | 
    | --- | --- |
    | 订阅 | 在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | 新资源组名称 **az30304b-labRG** |
    | 逻辑应用名称 | **az30304b-logicapp1** | 
    | 选择位置 | **区域** |
    | 位置 | 在上一个练习中选择的 Azure 区域的名称 |
    | Log Analytics | **关** |

1. 选择 **“查看 + 创建”**，然后选择 **“创建”**。 

    >**备注**： 等待逻辑应用完成创建。预配需要约 2 分钟。 


#### 任务 2：在 Azure 逻辑应用程序中添加触发器

1. 在 Azure 门户中，搜索并选择 **“逻辑应用”**，并且在 **“逻辑应用”** 边栏选项卡中，选择 **“az30304b-logicapp1”**。

1. 在 **“逻辑应用设计器”** 边栏选项卡中，选择 **“空白逻辑应用”**。这将显示一个空白的设计器工作区。

1. 使用 **“搜索连接器和触发器”** 文本框搜索 **“事件网格”**，并在结果列表的 **“触发器”** 列中，选择 **“当资源事件发生时”**，Azure 事件网格触发以添加该事件至设计器工作区。

1. 在 **“Azure 事件网格”** 磁贴中，选择 **“使用服务主体进行连接”** 链接，指定以下设置，然后选择 **“创建”**：

    | 设置 | 值 | 
    | --- | --- |
    | 连接名称 | **az30304egconnection** |
    | 客户端 ID | 你在本练习前面确定的 **“ApplicationId”** 属性的值 |
    | 客户端密码 | **Pa55w.rd1234.@z304** |
    | 租户 | 你在本练习前面确定的 **“TenantId”** 属性的值 |

1. 在 **“发生资源事件时”** 磁贴中，指定以下设置：

    | 设置 | 值 | 
    | --- | --- |
    | 订阅 | 从下拉列表中选择你的订阅 |
    | 资源类型 | **Microsoft.Resources.resourceGroups** |
    | 资源名称 | **az30304a-labRG** |
    | 事件类型项目 - 1 | **Microsoft.Resources.ResourceWriteSuccess** |
    | 事件类型项目 - 2 | **Microsoft.Resources.ResourceDeleteSuccess** |

1. 在 **“发生资源事件时”** 磁贴中，选择 **“添加新参数”**，然后选择 **“订阅名称”**

1. 在 **“订阅名称”** 文本框中，键入 **“event-subscription-az30304b”** 并选择 **“保存”**。


#### 任务 3：将条件添加到 Azure 逻辑应用

1. 在 Azure 门户中，在新预配的 Azure 逻辑应用的“逻辑应用设计器”边栏选项卡上，选择 **“添加新步骤”**。 

1. 在“选择操作”磁贴中，使用 **“搜索连接器和触发器”** 文本框搜索 **“条件”**，在结果列表中的 **“操作”** 列，选择 **“条件”** 并将其添加到设计器工作区中。

1. 选择位于 **“条件”** 磁贴右上角的省略号，在弹出菜单中选择 **“重命名”**，然后用 **“如果资源组中的虚拟机已更改”** 文本替换 **“条件”**。 

1. 在弹出窗口中，选择条件左侧的 **“选择值”** 文本框，然后在 **““表达式”** 选项卡中，输入以下表达式并选择 **““确定”**：

   ```
   triggerBody()?['data']['operationName']
   ```

1. 确保 **““等于”** 出现在条件的中间元素中，在右侧的 **““选择一个值”** 文本框中，键入代表你要监视的操作的值：

   ```
   Microsoft.Compute/virtualMachines/write
   ```

1. 在 **““逻辑应用设计器”** 边栏选项卡中，选择 **“保存”**。 


#### 任务 4：向 Azure 逻辑应用程序添加操作

1. 在 Azure 门户中，在新预配的 Azure 逻辑应用的“逻辑应用设计器”边栏选项卡的 **“True”** 磁贴上，选择 **“添加操作”**。 

1. 在 **“选择操作”** 窗格的 **“搜索连接器和操作”** 文本框内键入 **“Outlook”**。

1. 在结果列表中，选择 **“Outlook.com”**。 

1. 在 **“Outlook.com”** 的操作列表中，选择 **“发送电子邮件 (V2)”**。

1. 在 **“Outlook.com”** 窗格中，选择 **“登录”**。 

1. 出现提示时，使用你在本实验室中使用的 Microsoft 帐户进行身份验证。 

1. 当系统提示你是否同意授予 Azure 逻辑应用访问 Outlook 资源的权限时，请选择 **“同意”**。

1. 在 **“Outlook.com”** 窗格中，选择位于 **“发送电子邮件 (V2)”** 磁贴右上角的省略号，在弹出菜单中选择 **“重命名”**，然后用 **“发送电子邮件”** 文本替换 **“发送电子邮件 (v2)”**。 

1. 在 **“发送电子邮件”** 窗格，指定以下设置并选择 **“保存”**：

    | 设置 | 值 | 
    | --- | --- |
    | 收件人 | 你的 Microsoft 帐户的主要电子邮件地址 |
    | 主题 | 键入 **“已更新资源：”**，并且在 **“动态内容”** 列（**“发送电子邮件”** 窗格右边），选择 **“主题”** |
    | 正文 | 键入 **“资源组：”**，在 **“动态内容”** 列（在 **“发送电子邮件”** 窗格右侧）下的搜索文本框中，键入并选择 **“话题”**，回到 **“正文”** 文本框，在新行上键入 **“事件类型：”**，在 **“动态内容”** 列（在 **“发送电子邮件”** 窗格右侧）下的搜索文本框中，键入并选择 **“事件类型”**，回到 **“正文”** 文本框，在新行上键入 **“事件 ID：”**，在 **“动态内容”** 列（在 **“发送电子邮件”** 窗格右侧）下的搜索文本框中，键入并选择 **“ID”**，回到 **“正文”** 文本框，在新行上键入 **“事件时间：”**，然后在 **“动态内容”** 列（在 **“发送电子邮件”** 窗格右侧）下的搜索文本框中，键入并选择 **“事件时间”**。 |

    **你可能需要通过进入邮箱并输入电话号码来确认帐户。**

1. 在 **“逻辑应用设计器”** 边栏选项卡中，选择 **“保存”**。 


### 练习 3：实现事件订阅
  
本练习的主要任务如下：

1. 配置事件订阅

1. 查看 Azure 逻辑应用的功能

1. 删除实验室中部署的 Azure 资源


#### 任务 1：配置事件订阅

1. 在 Azure 门户中，导航到 **“az30304b-logicapp1”** 边栏选项卡，在 **“摘要”** 部分，选择 **“触发历史”**。 

1. 在 **“资源事件发生时”** 边栏选项卡上，复制 **“回叫 url[POST]”** 文本框的值。

1. 在 Azure 门户中，导航到 **“az30304a-LabRG”** 资源组，然后在垂直菜单中选择 **“事件”**。

1. 在 **“az30304a-LabRG | 事件”** 边栏选项卡，选择 **“添加事件订阅”**。

1. 在 **“创建事件订阅”** 边栏选项卡，指定以下设置并选择 **“创建”**：

    | 设置 | 值 | 
    | --- | --- |
    | 名称 | **event-subscription-az30304a-LabRG** |
    | 事件架构 | **事件网格架构** |
    | 系统主题名称 | **az30304b-eventgridtopic** |
    | 过滤到事件类型 | **资源写入成功**、**资源删除成功**、**资源操作成功** |
    | 终结点类型 | **Web Hook** | 
    | 终结点 | 你在此任务开始时复制的 URL 字符串 | |

1. 选择 **“创建”**。


#### 任务 2：查看 Azure 逻辑应用的功能

1. 在 Azure 门户中，导航到 **“az30304a-labRG”** 资源组，然后在资源列表中选择代表 **“az30304a-vm0”** Azure VM 的条目。

1. 在 **“az30304a-vm0”** 边栏选项卡中，在 **“设置”** 部分，选择 **“大小”**。

1. 在 **az30304a-vm0 | 大小”** 边栏选项卡，选择与当前设置不同的大小，然后选择 **“调整大小”**，并确认调整大小操作成功完成。 

1. 导航回 **“az30304b-logicapp1”** 边栏选项卡，选择 **“刷新”**，并注意 **“运行历史”** 包括与 Azure VM 状态更改相对应的条目。

1. 在 **“运行历史”** 列表中，选择持续时间最长的条目，代表在 Azure VM 上成功调整大小。

1. 在 **“逻辑应用运行”** 边栏选项卡，查看代表逻辑应用运行的工作流的关系图。

1. 在 **“逻辑应用运行”** 边栏选项卡，选择 **“当资源事件发生时”** 矩形以将其展开，并在 **“输出”** 部分，选择 **“显示原始输出”**。

1. 在 **“输出”** 边栏选项卡，查看事件的详细信息，并记录包括诸如用户帐户标识以及发送调整 Azure VM 大小请求的 IP 地址。 


1. 导航到在本练习前面部分指定的电子邮件帐户的收件箱，并验证其中是否包含由逻辑应用生成的电子邮件。


#### 任务 3：删除实验室中部署的 Azure 资源

1. 在“Cloud Shell”窗格中运行以下命令，以列出你在本练习中创建的资源组：

   ```powershell
   Get-AzResourceGroup -Name 'az30304*'
   ```

    > **备注**： 验证输出结果是否仅包含你在本实验室中创建的资源组。在本任务中将删除这个组。

1. 在“Cloud Shell”窗格中运行以下命令，以删除在本实验室中创建的资源组

   ```powershell
   Get-AzResourceGroup -Name 'az30304*' | Remove-AzResourceGroup -Force -AsJob
   ```

1. 关闭 Cloud Shell 窗格。
